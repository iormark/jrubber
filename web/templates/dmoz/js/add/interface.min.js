$(document).ready(function(){var r=$("#add__logout");var p=$("#console");var i=$("#info-count");var c=$("#info-size");var h=$("#file-field");var q=$("ul#img-list");var u=$("#img-container");var v=$("#filed__autocomplete");var g=0;var t=0;var n=0;var b=0;function k(w){$("<div/>").html(w).prependTo(p)}function f(){i.text((g==0)?"Изображений не выбрано":("Изображений выбрано: "+g));c.text(Math.round(n/1024))}function m(y,z){var x=y.width();var w=-x+(z*(x/100));y.attr("rel",z).css("background-position",w+"px center").text(z+"%")}function o(){t=$(q.find("li.down")).length}function s(x){var y=/image.*/;var w=0;$.each(x,function(D,C){if(!C.type.match(y)){k("Файл отсеян: `"+C.name+"` (тип "+C.type+")");return true}w++;var B;var A;if(b==0){A=q.find("li").eq(0)}else{A=$("<li/>").appendTo(q);$("<textarea/>").addClass("text").attr("name","text").appendTo(A)}$("<input/>").attr("type","hidden").attr("name","sort").attr("value",b).appendTo(A);$("<div/>").text(C.name).appendTo(A);B=$("<img/>").appendTo(A);$("<div/>").addClass("progress").attr("rel","0").text("0%").appendTo(A);$("<div/>").appendTo(A).append("<span>Не добавлять</span>").addClass("close").click(function(){$(A).remove();g--;n-=C.size;f()});$("<div/>").addClass("out").appendTo(A);A.get(0).file=C;b++;var z=new FileReader();z.onload=(function(E){return function(F){E.attr("src",F.target.result);E.attr("width",150);k("Картинка добавлена: `"+C.name+"` ("+Math.round(C.size/1024)+" Кб)");g++;n+=C.size;f()}})(B);z.readAsDataURL(C)})}h.bind({change:function(){k(this.files.length+" файл(ов) выбрано через поле выбора");s(this.files)}});u.bind({dragenter:function(){$(this).addClass("highlighted");return false},dragover:function(){return false},dragleave:function(){$(this).removeClass("highlighted");return false},drop:function(x){var w=x.originalEvent.dataTransfer;k(w.files.length+" файл(ов) выбрано через drag'n'drop");s(w.files);return false}});$("#upload-all").click(function(){k("Проверяем");$.post("/svc/FileUpload2",{q:"header",name:$("#add__post input[name='name']").val(),email:$("#add__post input[name='email']").val(),title:$("#add__post input[name='title']").val(),tags:$("#add__post input[name='tags']").val()},function(w){if(w.status=="ok"){l(w)}else{k(w.message)}},"json").fail(function(){$("#upload-all").removeAttr("disabled");k("Произошла ошибка! Пожалуйста, повторите попытку...")})});function l(){q.find("li").each(function(){var y=this;var x=$(y).find(".progress");if(!y.file){$.post("/svc/FileUpload2",{q:"article",name:$("#add__post input[name='name']").val(),email:$("#add__post input[name='email']").val(),title:$("#add__post input[name='title']").val(),tags:$("#add__post input[name='tags']").val(),text:$(y).find("textarea").val(),video:$("#add__post input[name='video']").val(),key:$("#add__post input[name='key']").val()},function(z){if(z.status=="ok"){k(z.message);j()}else{k(z.message)}},"json").fail(function(){$("#upload-all").removeAttr("disabled");k("Произошла ошибка! Пожалуйста, повторите попытку, \nпростите...")});return false}else{k("Загружаем...");var w=e();if(!w){return false}if($(y).hasClass("down")){k("Файл отсеян: `"+y.file.name+"` (тип "+y.file.type+")");return true}new uploaderObject({name:$("#add__post input[name='name']").val(),email:$("#add__post input[name='email']").val(),title:$("#add__post input[name='title']").val(),tags:$("#add__post input[name='tags']").val(),key:$("#add__post input[name='key']").val(),text:$(y).find("textarea").val(),video:$("#add__post input[name='video']").val(),sort:$(y).find('input[name="sort"]').val(),file:y.file,url:"/svc/FileUpload2",onprogress:function(z){m(x,z)},oncomplete:function(z,B){if(z){m(x,100);$(r).remove(".error");if(B.status=="ok"){$(y).addClass("down")}else{if(B.status=="error"){m(x,0);k("Ошибка: `"+y.file.name+"` ("+B.message+")")}}var A=e();if(!A){return false}}else{$("#upload-all").removeAttr("disabled");k("Ошибка: "+this.lastError.text)}}})}})}function e(){o();if(t==g){k("Проверяем...");$.post("/svc/FileUpload2",{q:"create",name:$("#add__post input[name='name']").val(),email:$("#add__post input[name='email']").val(),title:$("#add__post input[name='title']").val(),video:$("#add__post input[name='video']").val(),tags:$("#add__post input[name='tags']").val(),key:$("#add__post input[name='key']").val()},function(w){if(w.status=="ok"){k(w.message);j()}else{k(w.message)}},"json").fail(function(){$("#upload-all").removeAttr("disabled");k("Произошла ошибка! Пожалуйста, повторите попытку, \nпростите...")});return false}else{return true}}function j(){var w=$("#add__post");w.html("");$("<h1/>").text("Спасибо, пост отправлен").appendTo(w);$("<div/>").html('<a href="/">Ваша новость в разделе новое.</a>').appendTo(w);$("body,html").animate({scrollTop:0},0)}if(window.FileReader==null){k("Ваш браузер не поддерживает File API!")}$("#filed__tags").keyup(function(){$.getJSON(("/svc/FileUpload2?q=autocomplete&tags="+$(this).val()),function(w){v.html("");$.each(w[1],function(x,y){$("<div/>").html(y).appendTo(v).click(function(){a($(this).find(".tag").text())})})}).fail(function(){})});function a(w){var x=$("#filed__tags").val().split(",");x[x.length-1]=" "+w;w=d(x).toString()+", ";$("#filed__tags").val(w)}function d(w){var y={};for(var x=0;x<w.length;x++){var z=w[x];y[z]=true}return Object.keys(y)}});