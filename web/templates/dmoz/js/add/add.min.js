$(document).ready(function(){var u=$("#add__info");var m=$("#console");var o=$("#file_list");var h=$("#filed__add--text");var i=$("#filed__add--image");var l=$("#filed__add--video");var t=$("#filed__autocomplete");var n=$("#add__post input[name='post']").val();var j=false;var s=0;var q=o.find("li").length;var e=0;$("#upload").attr("disabled","disabled");$(o).sortable({zIndex:999,axis:"y",cursor:"move",opacity:1,tolerance:"intersect",update:function(){d()}});$(o).disableSelection();p();function p(){$(u).html("<span>Всего: "+q+"</span>")}function d(){var v=0;o.find("li").each(function(){$(this).find('input[name="sort"]').val(v++)});o.find("li").removeClass("read").addClass("update");$("#upload").removeAttr("disabled")}function g(v){$("<div/>").html(v).prependTo(m)}function f(w,v){$(w).find(".percent").css("width",v+"%").text(v+"%")}$(window).unload(function(){if(j){alert("Вы не сохранили изменения! Уверенны что хотите покинуть эту страницу?")}});$(document).on("change",".file_input",function(v){r(this)});$(document).on("change",'#file_list textarea, #file_list input[name="video"], #file_list input[name="sort"]',function(w){var v=$(this).parent();if($(this).val().trim()===""&&$(this).attr("name")!=="text"){v.removeClass("update").addClass("read")}else{v.removeClass("read").addClass("update")}$("#upload").removeAttr("disabled")});$(document).on("change",'#add__post input[name="title"], #add__post input[name="tags"], #add__post input[name="age"], #add__post input[name="profanity"]',function(v){if($('#add__post input[name="post"]').val()>0){j=true;$("#upload").removeAttr("disabled")}});h.click(function(){var v=$("<li/>").appendTo(o);var w=$("<div/>").addClass("item-options").appendTo(v);$("<span/>").addClass("item-delete").text("Удалить").appendTo(w);$("<textarea/>").addClass("text").attr("name","text").appendTo(v).autosize();$("<input/>").attr("type","hidden").attr("name","id").attr("value",0).appendTo(v);$("<input/>").attr("type","hidden").attr("name","sort").attr("value",q).appendTo(v);q++;p()});i.click(function(){var v=$("<li/>").appendTo(o);var w=$("<div/>").addClass("item-options").appendTo(v);$("<span/>").addClass("item-delete").text("Удалить").appendTo(w);$("<input/>").attr("type","file").addClass("file_input").attr("multiple","").appendTo(v);$("<input/>").attr("type","hidden").attr("name","id").attr("value",0).appendTo(v);$("<input/>").attr("type","hidden").attr("name","sort").attr("value",q).appendTo(v);q++;p()});l.click(function(){var v=$("<li/>").appendTo(o);var w=$("<div/>").addClass("item-options").appendTo(v);$("<span/>").addClass("item-delete").text("Удалить").appendTo(w);$("<div>").html("Видео (Coub): URL или &lt;iframe&gt;").appendTo(v);$("<input/>").attr("type","text").attr("name","video").attr("value","").attr("id","filed__video").appendTo(v);$("<input/>").attr("type","hidden").attr("name","id").attr("value",0).appendTo(v);$("<input/>").attr("type","hidden").attr("name","sort").attr("value",q).appendTo(v);q++;p()});$(document).on("click",".item-delete",function(w){if(!confirm("Это действие невозможно будет отменить! Вы уверены что хотите удалить этот элемент?")){return}var v=$(this).parent().parent();$.post("/svc/FileUpload",{url:"/svc/FileUpload",q:"item-delete",item:$(v).find('input[name="id"]').val()},function(x){if(x.status==="ok"){$(v).fadeOut(1000,function(){$(this).remove();q--;if($(v).hasClass("update")){e--}d();p()})}else{alert(x.message)}},"json").fail(function(){g("Произошла ошибка при удалении! Пожалуйста, повторите попытку, \nпростите...")})});function r(x){var v=/image.*/;var w=0;$.each(x.files,function(C,B){if(!B.type.match(v)){g("Файл отсеян: `"+B.name+"` (тип "+B.type+")");return true}var z;var D;if(w===0){z=$(x).parent();z.removeClass("read").addClass("update").addClass("file");D=z.find("img");if($(D).length===0){$("<div/>").addClass("file_name").text(B.name).appendTo(z);D=$("<img/>").appendTo(z);var A=$("<div/>").addClass("progress").appendTo(z);$("<div/>").addClass("percent").css("width",0).text("0%").appendTo(A)}else{z.find(".file_name").text(B.name);z.find(".percent").css("width",0).text("0%")}}else{z=$("<li/>").addClass("file").appendTo(o);$("<input/>").attr("type","file").attr("class","file_input").attr("multiple","").appendTo(z);$("<div/>").text(B.name).appendTo(z);D=$("<img/>").appendTo(z);$("<input/>").attr("type","hidden").attr("name","id").attr("value",0).appendTo(z);$("<input/>").attr("type","hidden").attr("name","sort").attr("value",q).appendTo(z);var A=$("<div/>").addClass("progress").appendTo(z);$("<div/>").addClass("percent").css("width",0).text("0%").appendTo(A);q++}z.get(0).file=B;w++;s++;var y=new FileReader();y.onload=(function(E){return function(F){E.attr("src",F.target.result);E.css("width",150);g("Картинка добавлена: `"+B.name+"` ("+Math.round(B.size/1024)+" Кб)");$("#upload").removeAttr("disabled");p()}})(D);y.readAsDataURL(B)})}$("#upload").click(function(){g("Секундочку...");$("#upload").attr("disabled","disabled");if(j){c()}o.find("li").each(function(){var w=this;if($(w).hasClass("read")){if(n>0){e++}$("#upload").removeAttr("disabled");return true}var y=$(w).find('input[name="id"]');var v=null;if(typeof(w.file)!=="undefined"){v=w.file}else{if($(w).find(".percent").text()==="100%"){v=true}else{v=false}}var x={url:"/svc/FileUpload",q:"item",title:$("#add__post input[name='title']").val(),tags:$("#add__post input[name='tags']").val(),key:$("#add__post input[name='key']").val(),text:typeof($(w).find("textarea").val())!=="undefined"?$(w).find("textarea").val():null,video:(typeof($(w).find('input[name="video"]').val())!=="undefined"?$(w).find('input[name="video"]').val():null),sort:$(w).find('input[name="sort"]').val(),file:v,item:(typeof(y.val())!=="undefined"?y.val():null),post:n};new Uploads(x,{onprogress:function(z){f(w,z)},oncomplete:function(z){if(z.status==="ok"&&z.item>=0){e++;$(w).removeClass("update").addClass("read");$(y).val(z.item);$(w).find(".error").remove();c()}else{if($(w).find(".percent").length>0){$(w).find(".percent").css("width",0).text("0%")}if($(w).find(".error").length===0){$("<div/>").addClass("error").html(z.message).appendTo(w)}else{$(w).find(".error").html(z.message)}$("#upload").removeAttr("disabled")}}})})});function c(){if((e===q)||j){e=0;g("Сохраняем...");$("#upload").attr("disabled","disabled");$.post("/svc/FileUpload",{url:"/svc/FileUpload",q:"create",title:$("#add__post input[name='title']").val(),tags:$("#add__post input[name='tags']").val(),age:$("#add__post input[name='age']:checked").val(),profanity:$("#add__post input[name='profanity']:checked").val(),key:$("#add__post input[name='key']").val(),post:$("#add__post input[name='post']").val()},function(v){if(v.status==="ok"&&v.post>=0){$("#add__post input[name='post']").val(v.post);j=false;location.href="/post?id="+v.post}else{$("#upload").removeAttr("disabled");alert(v.message)}},"json").fail(function(){$("#upload").removeAttr("disabled");g("Произошла ошибка! Пожалуйста, повторите попытку, \nпростите...2")})}else{$("#upload").removeAttr("disabled")}}$("#filed__tags").keyup(function(){$.getJSON(("/svc/FileUpload?q=autocomplete&tags="+$(this).val()),function(v){t.html("");$.each(v[1],function(w,x){$("<div/>").html(x).appendTo(t).click(function(){a($(this).find(".tag").text())})})}).fail(function(){})});function a(v){var w=$("#filed__tags").val().split(",");w[w.length-1]=" "+v;v=k(w).toString()+", ";$("#filed__tags").val(v)}function k(v){for(var x=0;x<v.length;x++){for(var w=x+1;w<v.length;w++){if($.trim(v[x].toLowerCase())===$.trim(v[w].toLowerCase())){v.splice(w,1)}}}return v}function b(v){var x={};for(var w=0;w<v.length;w++){var y=v[w];x[y]=true}return Object.keys(x)}});