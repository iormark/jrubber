(function(a){jQuery.fn.html5_upload=function(d){function f(h){return h.name||h.fileName}function g(h){return h.size||h.fileSize}var b=["onStart","onStartOne","onProgress","onFinishOne","onFinish","onError"];var d=jQuery.extend({onStart:function(i,h){return true},onStartOne:function(k,h,j,i){return true},onProgress:function(l,i,h,k,j){},onFinishOne:function(l,h,i,k,j){},onFinish:function(i,h){},onError:function(j,i,h){},onBrowserIncompatible:function(){alert("Sorry, but your browser is incompatible with uploading files using HTML5 (at least, with current preferences.\n Please install the latest version of Firefox, Safari or Chrome")},autostart:true,autoclear:true,stopOnFirstError:false,sendBoundary:false,fieldName:"user_file[]",extraFields:{},method:"post",STATUSES:{STARTED:"Started",PROGRESS:"Progress",LOADED:"Loaded",FINISHED:"Finished"},headers:{"Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest","X-File-Name":function(h){return f(h)},"X-File-Size":function(h){return g(h)},"X-CSRF-Token":a('meta[name="csrf-token"]').attr("content"),"Content-Type":function(h){if(!d.sendBoundary){return"multipart/form-data"}return false}},setName:function(h){},setStatus:function(h){},setProgress:function(h){},genName:function(h,j,i){return h+"("+(j+1)+" из "+i+")"},genStatus:function(h,i){if(i){return d.STATUSES.FINISHED}if(h==0){return d.STATUSES.STARTED}else{if(h==1){return d.STATUSES.LOADED}else{return d.STATUSES.PROGRESS}}},genProgress:function(h,i){return h/i}},d);function c(){var k=this.files;var j=k.length;var l=a(this);if(!l.triggerHandler("html5_upload.onStart",[j])){return false}this.disabled=true;var h=0;var m=this.html5_upload.xhr;this.html5_upload.continue_after_abort=true;function i(p){if(p==j){l.triggerHandler("html5_upload.onFinish",[j]);d.setStatus(d.genStatus(1,true));l.attr("disabled",false);if(d.autoclear){l.val("")}return}var o=k[p];if(!l.triggerHandler("html5_upload.onStartOne",[f(o),p,j])){return i(p+1)}d.setStatus(d.genStatus(0));d.setName(d.genName(f(o),p,j));d.setProgress(d.genProgress(0,g(o)));m.upload.onprogress=function(u){l.triggerHandler("html5_upload.onProgress",[u.loaded/u.total,f(o),p,j]);d.setStatus(d.genStatus(u.loaded/u.total));d.setProgress(d.genProgress(u.loaded,u.total))};m.onload=function(u){if(m.status!=200){l.triggerHandler("html5_upload.onError",[f(o),u]);if(!d.stopOnFirstError){i(p+1)}}else{l.triggerHandler("html5_upload.onFinishOne",[m.responseText,f(o),p,j]);d.setStatus(d.genStatus(1,true));d.setProgress(d.genProgress(g(o),g(o)));i(p+1)}};m.onabort=function(){if(l[0].html5_upload.continue_after_abort){i(p+1)}else{l.attr("disabled",false);if(d.autoclear){l.val("")}}};m.onerror=function(u){l.triggerHandler("html5_upload.onError",[f(o),u]);if(!d.stopOnFirstError){i(p+1)}};m.open(d.method,typeof(d.url)=="function"?d.url(p):d.url,true);a.each(d.headers,function(u,v){v=typeof(v)=="function"?v(o):v;if(v===false){return true}m.setRequestHeader(u,v)});if(!d.sendBoundary){m.send(o)}else{if(window.FormData){var q=new FormData();q.append(typeof(d.fieldName)=="function"?d.fieldName():d.fieldName,o);a.each(d.extraFields,function(u,v){q.append(u,v)});m.send(q)}else{if(o.getAsBinary){var t="------multipartformboundary"+(new Date).getTime();var r="--";var s="\r\n";var n="";n+=r;n+=t;n+=s;n+='Content-Disposition: form-data; name="'+(typeof(d.fieldName)=="function"?d.fieldName():d.fieldName)+'"';fileName=unescape(encodeURIComponent(f(o)));n+='; filename="'+fileName+'"';n+=s;n+="Content-Type: "+o.type;n+=s;n+=s;n+=o.getAsBinary();n+=s;n+=r;n+=t;n+=r;n+=s;m.setRequestHeader("content-type","multipart/form-data; boundary="+t);m.sendAsBinary(n)}else{d.onBrowserIncompatible()}}}}i(0);return true}try{return this.each(function(){this.html5_upload={xhr:new XMLHttpRequest(),continue_after_abort:true};if(d.autostart){a(this).bind("change",c)}for(event in b){if(d[b[event]]){a(this).bind("html5_upload."+b[event],d[b[event]])}}a(this).bind("html5_upload.start",c).bind("html5_upload.cancelOne",function(){this.html5_upload.xhr.abort()}).bind("html5_upload.cancelAll",function(){this.html5_upload.continue_after_abort=false;this.html5_upload.xhr.abort()}).bind("html5_upload.destroy",function(){this.html5_upload.continue_after_abort=false;this.xhr.abort();delete this.html5_upload;a(this).unbind("html5_upload.*").unbind("change",c)})})}catch(e){d.onBrowserIncompatible();return false}}})(jQuery);